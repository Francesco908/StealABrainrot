-- OnlyRobloxScript - Versione Aggiornata
-- GUI compatta e movibile con funzionalità complete

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualUser = game:GetService("VirtualUser")
local StarterGui = game:GetService("StarterGui")
local Debris = game:GetService("Debris")

-- Variabili di performance
local FRAME_SKIP = 3
local ESP_UPDATE_RATE = 10
local frameCount = 0

-- Variabili globali
local player = Players.LocalPlayer
local camera = workspace.CurrentCamera
local mainGui = nil
local minimizedGui = nil
local masterConnection = nil
local states = {
    godMode = false,
    infiniteJump = false,
    speedBoost = false,
    noclip = false,
    fly = false,
    espBox = false,
    espNames = false,
    tpBase = false,
    stealHelper = false
}

local flyPart = nil
local basePosition = nil
local espObjects = {}
local lastJumpTime = 0
local stealHelperFrame = nil

-- Colori semplificati
local bgColor = Color3.new(0.1, 0.1, 0.1)
local fgColor = Color3.new(0.2, 0.2, 0.2)
local btnColor = Color3.new(0.3, 0.3, 0.3)
local activeColor = Color3.new(0, 0.7, 0)
local textColor = Color3.new(1, 1, 1)

-- Funzioni di utilità
local function createFrame(parent, size, position, color)
    local frame = Instance.new("Frame")
    frame.Size = size
    frame.Position = position
    frame.BackgroundColor3 = color
    frame.BorderSizePixel = 0
    frame.Parent = parent
    return frame
end

local function createButton(parent, size, position, text, color)
    local button = Instance.new("TextButton")
    button.Size = size
    button.Position = position
    button.BackgroundColor3 = color or btnColor
    button.Text = text
    button.TextColor3 = textColor
    button.TextScaled = true
    button.Font = Enum.Font.SourceSans
    button.BorderSizePixel = 0
    button.Parent = parent
    return button
end

local function createLabel(parent, size, position, text)
    local label = Instance.new("TextLabel")
    label.Size = size
    label.Position = position
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = textColor
    label.TextScaled = true
    label.Font = Enum.Font.SourceSans
    label.Parent = parent
    return label
end

local function makeDraggable(frame)
    local dragging = false
    local dragStart = nil
    local startPos = nil
    
    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
        end
    end)
    
    frame.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            frame.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end)
end

-- Sistema di volo avanzato
local FLIGHT_SPEED = 50
local FLOAT_HEIGHT = 8
local bodyVelocity = nil
local bodyAngularVelocity = nil

local function createAdvancedBodyMovers(rootPart)
    bodyVelocity = Instance.new("BodyVelocity")
    bodyVelocity.MaxForce = Vector3.new(5000, 5000, 5000)
    bodyVelocity.Velocity = Vector3.new(0, 0, 0)
    bodyVelocity.Parent = rootPart
    
    bodyAngularVelocity = Instance.new("BodyAngularVelocity")
    bodyAngularVelocity.MaxTorque = Vector3.new(0, 5000, 0)
    bodyAngularVelocity.AngularVelocity = Vector3.new(0, 0, 0)
    bodyAngularVelocity.Parent = rootPart
end

local function removeAllBodyMovers()
    if bodyVelocity then
        bodyVelocity:Destroy()
        bodyVelocity = nil
    end
    if bodyAngularVelocity then
        bodyAngularVelocity:Destroy()
        bodyAngularVelocity = nil
    end
end

local function startFlight(target)
    local character = player.Character
    if not character then return end
    local humanoid = character:FindFirstChild("Humanoid")
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    
    if not humanoid or not rootPart then return end
    
    createAdvancedBodyMovers(rootPart)
    
    local startPos = rootPart.Position
    local floatPos = Vector3.new(startPos.X, startPos.Y + FLOAT_HEIGHT, startPos.Z)
    
    bodyVelocity.Velocity = Vector3.new(0, 20, 0)
    
    local ascentMonitor = RunService.Heartbeat:Connect(function()
        if (rootPart.Position - floatPos).Magnitude < 1 then
            ascentMonitor:Disconnect()
            local direction = (target - rootPart.Position).Unit
            bodyVelocity.Velocity = direction * FLIGHT_SPEED
            
            RunService.Heartbeat:Connect(function()
                if (rootPart.Position - target).Magnitude < 8 then
                    removeAllBodyMovers()
                end
            end)
        end
    end)
end

-- Gestione base
local function setBasePosition()
    local rootPart = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if rootPart then
        basePosition = rootPart.Position
        StarterGui:SetCore("SendNotification", {
            Title = "Base Set",
            Text = "Position saved successfully!",
            Duration = 3
        })
    end
end

local function teleportToBase()
    if basePosition then
        startFlight(basePosition)
    else
        StarterGui:SetCore("SendNotification", {
            Title = "Error",
            Text = "Set base position first!",
            Duration = 3
        })
    end
end

-- Steal Helper migliorato
local function createStealHelper()
    if stealHelperFrame then stealHelperFrame:Destroy() end
    
    stealHelperFrame = Instance.new("Frame")
    stealHelperFrame.Size = UDim2.new(0, 150, 0, 80)
    stealHelperFrame.Position = UDim2.new(0.7, 0, 0.5, -40)
    stealHelperFrame.BackgroundColor3 = bgColor
    stealHelperFrame.Parent = CoreGui
    makeDraggable(stealHelperFrame)
    
    local title = createLabel(stealHelperFrame, UDim2.new(1, 0, 0, 20), UDim2.new(0, 0, 0, 0), "Steal Helper")
    
    local upBtn = createButton(stealHelperFrame, UDim2.new(0.45, 0, 0, 25), UDim2.new(0.025, 0, 0, 25), "UP", activeColor)
    local downBtn = createButton(stealHelperFrame, UDim2.new(0.45, 0, 0, 25), UDim2.new(0.525, 0, 0, 25), "DOWN", btnColor)
    local closeBtn = createButton(stealHelperFrame, UDim2.new(0.2, 0, 0, 20), UDim2.new(0.4, 0, 0, 55), "CLOSE", Color3.new(0.8, 0, 0))
    
    upBtn.MouseButton1Click:Connect(function()
        local rootPart = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
        if rootPart then
            rootPart.CFrame = rootPart.CFrame + Vector3.new(0, 180, 0)
        end
    end)
    
    downBtn.MouseButton1Click:Connect(function()
        local rootPart = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
        if rootPart then
            rootPart.CFrame = rootPart.CFrame - Vector3.new(0, 60, 0)
        end
    end)
    
    closeBtn.MouseButton1Click:Connect(function()
        stealHelperFrame:Destroy()
        stealHelperFrame = nil
        states.stealHelper = false
    end)
end

-- Funzioni principali
local function createMasterConnection()
    if masterConnection then masterConnection:Disconnect() end
    
    masterConnection = RunService.Heartbeat:Connect(function()
        frameCount = frameCount + 1
        if frameCount % FRAME_SKIP ~= 0 then return end
        
        local character = player.Character
        if not character then return end
        
        local humanoid = character:FindFirstChild("Humanoid")
        local rootPart = character:FindFirstChild("HumanoidRootPart")
        
        -- God Mode
        if states.godMode and humanoid and frameCount % 6 == 0 then
            humanoid.Health = humanoid.MaxHealth
        end
        
        -- Speed Boost
        if states.speedBoost and humanoid then
            humanoid.WalkSpeed = 25
        end
        
        -- Noclip
        if states.noclip and frameCount % 2 == 0 then
            for _, part in ipairs(character:GetChildren()) do
                if part:IsA("BasePart") then
                    part.CanCollide = false
                end
            end
        end
        
        -- Fly
        if states.fly and rootPart and flyPart then
            flyPart.CFrame = rootPart.CFrame - Vector3.new(0, 3.5, 0)
            
            local moveVector = Vector3.new(0, 0, 0)
            local cam = camera
            
            if UserInputService:IsKeyDown(Enum.KeyCode.W) then moveVector += cam.CFrame.LookVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.S) then moveVector -= cam.CFrame.LookVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.A) then moveVector -= cam.CFrame.RightVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.D) then moveVector += cam.CFrame.RightVector end
            if UserInputService:IsKeyDown(Enum.KeyCode.Space) then moveVector += Vector3.new(0, 1, 0) end
            if UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then moveVector -= Vector3.new(0, 1, 0) end
            
            if moveVector.Magnitude > 0 then
                rootPart.Velocity = moveVector.Unit * 50
            end
        end
    end)
end

-- GUI principale compatta
local function createMainGui()
    if mainGui then mainGui:Destroy() end
    
    mainGui = Instance.new("ScreenGui")
    mainGui.Name = "OnlyRobloxScript"
    mainGui.Parent = CoreGui
    
    -- Frame principale compatto
    local mainFrame = createFrame(mainGui, UDim2.new(0, 250, 0, 300), UDim2.new(0.5, -125, 0.5, -150), bgColor)
    mainFrame.Active = true
    makeDraggable(mainFrame)
    
    -- Barra del titolo
    local titleBar = createFrame(mainFrame, UDim2.new(1, 0, 0, 25), UDim2.new(0, 0, 0, 0), fgColor)
    local title = createLabel(titleBar, UDim2.new(0.7, 0, 1, 0), UDim2.new(0, 5, 0, 0), "OnlyRobloxScript")
    local closeBtn = createButton(titleBar, UDim2.new(0, 25, 0, 25), UDim2.new(1, -25, 0, 0), "X", Color3.new(0.8, 0, 0))
    
    -- Contenuto compatto
    local content = createFrame(mainFrame, UDim2.new(1, -10, 1, -35), UDim2.new(0, 5, 0, 30), bgColor)
    
    -- Pulsanti delle funzionalità
    local yOffset = 5
    local function addButton(text, callback)
        local btn = createButton(content, UDim2.new(1, 0, 0, 30), UDim2.new(0, 0, 0, yOffset), text)
        btn.MouseButton1Click = callback
        yOffset += 35
        return btn
    end
    
    addButton("God Mode", function()
        states.godMode = not states.godMode
        createMasterConnection()
    end)
    
    addButton("Infinite Jump", function()
        states.infiniteJump = not states.infiniteJump
    end)
    
    addButton("Speed Boost", function()
        states.speedBoost = not states.speedBoost
        createMasterConnection()
    end)
    
    addButton("Noclip", function()
        states.noclip = not states.noclip
        createMasterConnection()
    end)
    
    addButton("Fly", function()
        states.fly = not states.fly
        if states.fly then
            flyPart = Instance.new("Part")
            flyPart.Size = Vector3.new(5, 0.2, 5)
            flyPart.Transparency = 1
            flyPart.CanCollide = true
            flyPart.Anchored = true
            flyPart.Parent = workspace
        else
            flyPart:Destroy()
            flyPart = nil
        end
        createMasterConnection()
    end)
    
    addButton("Set Base", function()
        setBasePosition()
    end)
    
    addButton("TP to Base", function()
        teleportToBase()
    end)
    
    addButton("Steal Helper", function()
        states.stealHelper = not states.stealHelper
        if states.stealHelper then
            createStealHelper()
        elseif stealHelperFrame then
            stealHelperFrame:Destroy()
            stealHelperFrame = nil
        end
    end)
    
    -- Funzioni di chiusura
    closeBtn.MouseButton1Click:Connect(function()
        mainGui:Destroy()
        if stealHelperFrame then
            stealHelperFrame:Destroy()
        end
        if flyPart then
            flyPart:Destroy()
        end
    end)
end

-- Inizializzazione
createMainGui()

-- Notifica
StarterGui:SetCore("SendNotification", {
    Title = "OnlyRobloxScript",
    Text = "Loaded successfully!",
    Duration = 3
})

-- Anti-idle
player.Idled:Connect(function()
    VirtualUser:Button2Down(Vector2.new(0, 0), camera.CFrame)
    wait(0.1)
    VirtualUser:Button2Up(Vector2.new(0, 0), camera.CFrame)
end)
