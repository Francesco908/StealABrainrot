-- Load Fluent library
local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

-- Create main window optimized for mobile
local Window = Fluent:CreateWindow({
    Title = "Water HUB",
    SubTitle = "",
    TabWidth = 120,
    Size = UDim2.fromOffset(355, 320),
    Acrylic = true,
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.LeftControl
})

-- Create persistent image (always visible)
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

local persistentGui = Instance.new("ScreenGui")
persistentGui.Name = "FluentPersistentButton"
persistentGui.Parent = playerGui
persistentGui.ResetOnSpawn = false
persistentGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
persistentGui.Enabled = true

-- Main button
local imageButton = Instance.new("ImageButton")
imageButton.Name = "PersistentControl"
imageButton.Size = UDim2.fromOffset(70, 70)
imageButton.Position = UDim2.new(0, 20, 0.5, -35)
imageButton.AnchorPoint = Vector2.new(0, 0.5)
imageButton.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
imageButton.BorderSizePixel = 0
imageButton.Image = "rbxassetid://7072717836"
imageButton.ScaleType = Enum.ScaleType.Fit
imageButton.Parent = persistentGui

-- Transparency effect
imageButton.BackgroundTransparency = 0.5
imageButton.ImageTransparency = 0.2

-- Rounded corners
local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0.3, 0)
corner.Parent = imageButton

-- Hover effect
local TweenService = game:GetService("TweenService")
local hoverTween = TweenService:Create(imageButton, TweenInfo.new(0.3), {
    BackgroundTransparency = 0.2,
    ImageTransparency = 0,
    Size = UDim2.fromOffset(75, 75)
})
local normalTween = TweenService:Create(imageButton, TweenInfo.new(0.3), {
    BackgroundTransparency = 0.5,
    ImageTransparency = 0.2,
    Size = UDim2.fromOffset(70, 70)
})

imageButton.MouseEnter:Connect(function()
    hoverTween:Play()
end)
imageButton.MouseLeave:Connect(function()
    normalTween:Play()
end)

-- Dragging variables
local dragging = false
local dragStart = nil
local startPos = nil

-- Drag functions
local function onDragStart(input)
    dragging = true
    dragStart = input.Position
    startPos = imageButton.Position
end

local function onDragEnd(input)
    dragging = false
end

local function onDragMove(input)
    if dragging then
        local delta = input.Position - dragStart
        imageButton.Position = UDim2.new(
            startPos.X.Scale,
            startPos.X.Offset + delta.X,
            startPos.Y.Scale,
            startPos.Y.Offset + delta.Y
        )
    end
end

-- Connect drag events
imageButton.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        onDragStart(input)
    end
end)

imageButton.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        onDragEnd(input)
    end
end)

imageButton.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        onDragMove(input)
    end
end)

-- Toggle menu function
local function toggleMenu()
    if Window and Window.Root then
        Window.Root.Visible = not Window.Root.Visible
    end
end

-- Click handler
imageButton.MouseButton1Click:Connect(function()
    if not dragging then
        toggleMenu()
    end
end)

-- Intercept LeftControl
local UserInputService = game:GetService("UserInputService")
local function onKeyDown(key, gameProcessed)
    if key.KeyCode == Enum.KeyCode.LeftControl then
        if persistentGui.Enabled then
            toggleMenu()
            return
        end
    end
end

UserInputService.InputBegan:Connect(onKeyDown)

-- Variables for features
local speedBoostEnabled = false
local antiTrapEnabled = false
local antiStunEnabled = false
local espPlayersEnabled = false
local espBoxEnabled = false
local autoCollectMoney = false
local fastStealEnabled = false
local infiniteJumpEnabled = false

-- Helper variables
local stealHelperGui = nil
local originalWalkSpeed = 16
local originalJumpPower = 50
local espBoxes = {}
local antiTrapConnection = nil
local antiStunConnection = nil
local infiniteJumpConnection = nil
local lastAttacker = nil

-- Create tabs
local Tabs = {
    Main = Window:AddTab({ Title = "Main", Icon = "home" }),
    Money = Window:AddTab({ Title = "Money", Icon = "dollar-sign" }),
    Visual = Window:AddTab({ Title = "Visual", Icon = "eye" }),
    Misc = Window:AddTab({ Title = "Misc", Icon = "settings" })
}

-- MAIN TAB
-- Speed Boost
Tabs.Main:AddToggle("SpeedBoost", {
    Title = "Speed Boost 8x (50% Bypass)",
    Default = false,
    Callback = function(value)
        speedBoostEnabled = value
        if player.Character and player.Character:FindFirstChild("Humanoid") then
            if value then
                player.Character.Humanoid.WalkSpeed = originalWalkSpeed * 8
                player.Character.Humanoid.JumpPower = originalJumpPower * 4
            else
                player.Character.Humanoid.WalkSpeed = originalWalkSpeed
                player.Character.Humanoid.JumpPower = originalJumpPower
            end
        end
    end
})

-- Anti trap with movement freedom
Tabs.Main:AddToggle("AntiTrap", {
    Title = "Anti Trap (Movement Freedom)",
    Default = false,
    Callback = function(value)
        antiTrapEnabled = value
        if player.Character and player.Character:FindFirstChild("Humanoid") then
            if value then
                -- Enable anti-trap functionality
                antiTrapConnection = RunService.Heartbeat:Connect(function()
                    if player.Character and player.Character:FindFirstChild("Humanoid") then
                        local humanoid = player.Character.Humanoid
                        -- Reset any forced states that might trap the player
                        humanoid.PlatformStand = false
                        humanoid.Sit = false
                        
                        -- Prevent getting stuck in place
                        if player.Character:FindFirstChild("HumanoidRootPart") then
                            local rootPart = player.Character.HumanoidRootPart
                            -- Ensure the player can always move
                            rootPart.Anchored = false
                        end
                        
                        -- Remove any potential trap effects
                        for _, v in pairs(player.Character:GetChildren()) do
                            if v:IsA("BodyPosition") or v:IsA("BodyVelocity") or v:IsA("BodyAngularVelocity") then
                                v:Destroy()
                            end
                        end
                    end
                })
            else
                -- Disable anti-trap functionality
                if antiTrapConnection then
                    antiTrapConnection:Disconnect()
                    antiTrapConnection = nil
                end
            end
        end
    end
})

-- Enhanced Anti Stun (god mode)
Tabs.Main:AddToggle("AntiStun", {
    Title = "Anti Stun (God Mode)",
    Default = false,
    Callback = function(value)
        antiStunEnabled = value
        
        -- Disconnect previous connection if exists
        if antiStunConnection then
            antiStunConnection:Disconnect()
            antiStunConnection = nil
        end
        
        if value then
            antiStunConnection = player.Character.Humanoid:GetPropertyChangedSignal("PlatformStand"):Connect(function()
                if antiStunEnabled then
                    player.Character.Humanoid.PlatformStand = false
                end
            end)
            
            -- Detect who hit you
            player.Character.Humanoid.Touched:Connect(function(part)
                if part:IsA("BasePart") and part.Parent and part.Parent:FindFirstChild("Humanoid") then
                    local attacker = part.Parent
                    if attacker ~= player.Character then
                        lastAttacker = attacker
                    end
                end
            end)
            
            -- Anti-stun protection
            RunService.Heartbeat:Connect(function()
                if antiStunEnabled and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                    -- Prevent flying/falling
                    player.Character.HumanoidRootPart.Velocity = Vector3.new(
                        player.Character.HumanoidRootPart.Velocity.X,
                        0,
                        player.Character.HumanoidRootPart.Velocity.Z
                    )
                    
                    -- Reset any stun effects
                    player.Character.Humanoid.PlatformStand = false
                    player.Character.Humanoid.Sit = false
                    
                    -- Remove forces from last attacker
                    if lastAttacker and lastAttacker.Parent then
                        for _, v in pairs(lastAttacker:GetChildren()) do
                            if v:IsA("BodyPosition") or v:IsA("BodyVelocity") or v:IsA("BodyAngularVelocity") then
                                v:Destroy()
                            end
                        end
                    end
                end
            end)
        else
            if antiStunConnection then
                antiStunConnection:Disconnect()
                antiStunConnection = nil
            end
        end
    end
})

-- MONEY TAB
-- Money label
local moneyLabel = Tabs.Money:AddParagraph({
    Title = "Current Money",
    Content = "0"
})

-- Auto collect money
Tabs.Money:AddToggle("AutoCollectMoney", {
    Title = "Auto Collect Money",
    Default = false,
    Callback = function(value)
        autoCollectMoney = value
    end
})

-- VISUAL TAB
-- ESP Players
Tabs.Visual:AddToggle("ESPPlayers", {
    Title = "ESP Player Highlights",
    Default = false,
    Callback = function(value)
        espPlayersEnabled = value
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= Players.LocalPlayer and player.Character then
                local highlight = player.Character:FindFirstChild("Highlight")
                if value then
                    if not highlight then
                        highlight = Instance.new("Highlight")
                        highlight.Parent = player.Character
                        highlight.FillColor = Color3.fromRGB(255, 0, 0)
                        highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
                    end
                else
                    if highlight then
                        highlight:Destroy()
                    end
                end
            end
        end
    end
})

-- ESP Box functions
local function createESPBox(character)
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return end
    
    local billboardGui = Instance.new("BillboardGui")
    billboardGui.Name = "ESPBox"
    billboardGui.Adornee = humanoidRootPart
    billboardGui.Size = UDim2.new(4, 0, 6, 0)
    billboardGui.StudsOffset = Vector3.new(0, 0, 0)
    billboardGui.Parent = character
    
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 1, 0)
    frame.BackgroundTransparency = 1
    frame.Parent = billboardGui
    
    -- Create box outline
    local function createLine(name, size, position)
        local line = Instance.new("Frame")
        line.Name = name
        line.Size = size
        line.Position = position
        line.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
        line.BorderSizePixel = 0
        line.Parent = frame
        return line
    end
    
    -- Top line
    createLine("Top", UDim2.new(1, 0, 0, 2), UDim2.new(0, 0, 0, 0))
    -- Bottom line
    createLine("Bottom", UDim2.new(1, 0, 0, 2), UDim2.new(0, 0, 1, -2))
    -- Left line
    createLine("Left", UDim2.new(0, 2, 1, 0), UDim2.new(0, 0, 0, 0))
    -- Right line
    createLine("Right", UDim2.new(0, 2, 1, 0), UDim2.new(1, -2, 0, 0))
    
    -- Player name
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Size = UDim2.new(1, 0, 0, 20)
    nameLabel.Position = UDim2.new(0, 0, 0, -25)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = character.Name
    nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    nameLabel.TextSize = 14
    nameLabel.Font = Enum.Font.SourceSansBold
    nameLabel.TextStrokeTransparency = 0
    nameLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    nameLabel.Parent = frame
    
    return billboardGui
end

local function removeESPBox(character)
    local espBox = character:FindFirstChild("ESPBox")
    if espBox then
        espBox:Destroy()
    end
end

-- ESP Box toggle
Tabs.Visual:AddToggle("ESPBox", {
    Title = "ESP Box",
    Default = false,
    Callback = function(value)
        espBoxEnabled = value
        for _, targetPlayer in pairs(Players:GetPlayers()) do
            if targetPlayer ~= Players.LocalPlayer and targetPlayer.Character then
                if value then
                    createESPBox(targetPlayer.Character)
                else
                    removeESPBox(targetPlayer.Character)
                end
            end
        end
    end
})

-- MISC TAB
-- Fast steal
Tabs.Misc:AddToggle("FastSteal", {
    Title = "Fast Steal",
    Default = false,
    Callback = function(value)
        fastStealEnabled = value
    end
})

-- Steal Helper (wider GUI)
Tabs.Misc:AddButton({
    Title = "Steal Helper",
    Description = "Open steal helper GUI",
    Callback = function()
        if stealHelperGui then
            stealHelperGui:Destroy()
        end
        
        -- Create steal helper GUI with beautiful gray transparent design (wider)
        stealHelperGui = Instance.new("ScreenGui")
        stealHelperGui.Name = "StealHelper"
        stealHelperGui.Parent = playerGui
        stealHelperGui.ResetOnSpawn = false
        
        -- Increased width to 350 pixels
        local frame = Instance.new("Frame")
        frame.Size = UDim2.fromOffset(350, 200)  -- Wider by 70 pixels
        frame.Position = UDim2.new(0.5, -175, 0.5, -100)  -- Adjusted position
        frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
        frame.BackgroundTransparency = 0.15
        frame.BorderSizePixel = 0
        frame.Parent = stealHelperGui
        
        -- Glass effect backdrop
        local backdrop = Instance.new("Frame")
        backdrop.Size = UDim2.new(1, 0, 1, 0)
        backdrop.Position = UDim2.new(0, 0, 0, 0)
        backdrop.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
        backdrop.BackgroundTransparency = 0.95
        backdrop.BorderSizePixel = 0
        backdrop.Parent = frame
        
        -- Main frame corner
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 16)
        corner.Parent = frame
        
        -- Backdrop corner
        local backdropCorner = Instance.new("UICorner")
        backdropCorner.CornerRadius = UDim.new(0, 16)
        backdropCorner.Parent = backdrop
        
        -- Stroke for glass effect
        local stroke = Instance.new("UIStroke")
        stroke.Color = Color3.fromRGB(255, 255, 255)
        stroke.Transparency = 0.8
        stroke.Thickness = 1
        stroke.Parent = frame
        
        -- Title bar
        local titleBar = Instance.new("Frame")
        titleBar.Size = UDim2.new(1, 0, 0, 45)
        titleBar.Position = UDim2.new(0, 0, 0, 0)
        titleBar.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
        titleBar.BackgroundTransparency = 0.2
        titleBar.BorderSizePixel = 0
        titleBar.Parent = frame
        
        local titleCorner = Instance.new("UICorner")
        titleCorner.CornerRadius = UDim.new(0, 16)
        titleCorner.Parent = titleBar
        
        -- Fix title bar bottom corners
        local titleFix = Instance.new("Frame")
        titleFix.Size = UDim2.new(1, 0, 0, 16)
        titleFix.Position = UDim2.new(0, 0, 1, -16)
        titleFix.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
        titleFix.BackgroundTransparency = 0.2
        titleFix.BorderSizePixel = 0
        titleFix.Parent = titleBar
        
        -- Title text
        local title = Instance.new("TextLabel")
        title.Size = UDim2.new(1, -50, 1, 0)
        title.Position = UDim2.new(0, 15, 0, 0)
        title.BackgroundTransparency = 1
        title.Text = "üíß Water HUB - Steal Helper"
        title.TextColor3 = Color3.fromRGB(255, 255, 255)
        title.TextSize = 16
        title.Font = Enum.Font.SourceSansBold
        title.TextXAlignment = Enum.TextXAlignment.Left
        title.Parent = titleBar
        
        -- Close button
        local closeBtn = Instance.new("TextButton")
        closeBtn.Size = UDim2.fromOffset(30, 30)
        closeBtn.Position = UDim2.new(1, -38, 0, 7.5)
        closeBtn.BackgroundColor3 = Color3.fromRGB(255, 70, 70)
        closeBtn.BackgroundTransparency = 0.1
        closeBtn.Text = "‚úï"
        closeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        closeBtn.TextSize = 14
        closeBtn.Font = Enum.Font.SourceSansBold
        closeBtn.Parent = titleBar
        
        local closeCorner = Instance.new("UICorner")
        closeCorner.CornerRadius = UDim.new(0, 8)
        closeCorner.Parent = closeBtn
        
        -- Close button hover effect
        local closeHover = TweenService:Create(closeBtn, TweenInfo.new(0.2), {BackgroundTransparency = 0})
        local closeNormal = TweenService:Create(closeBtn, TweenInfo.new(0.2), {BackgroundTransparency = 0.1})
        
        closeBtn.MouseEnter:Connect(function() closeHover:Play() end)
        closeBtn.MouseLeave:Connect(function() closeNormal:Play() end)
        
        closeBtn.MouseButton1Click:Connect(function()
            stealHelperGui:Destroy()
        end)
        
        -- Up button
        local upBtn = Instance.new("TextButton")
        upBtn.Size = UDim2.new(1, -30, 0, 60)
        upBtn.Position = UDim2.new(0, 15, 0, 60)
        upBtn.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
        upBtn.BackgroundTransparency = 0.3
        upBtn.Text = "‚¨ÜÔ∏è UP (165)"
        upBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        upBtn.TextSize = 18
        upBtn.Font = Enum.Font.SourceSansBold
        upBtn.Parent = frame
        
        local upCorner = Instance.new("UICorner")
        upCorner.CornerRadius = UDim.new(0, 12)
        upCorner.Parent = upBtn
        
        local upStroke = Instance.new("UIStroke")
        upStroke.Color = Color3.fromRGB(0, 200, 100)
        upStroke.Transparency = 0.5
        upStroke.Thickness = 2
        upStroke.Parent = upBtn
        
        -- Down button
        local downBtn = Instance.new("TextButton")
        downBtn.Size = UDim2.new(1, -30, 0, 60)
        downBtn.Position = UDim2.new(0, 15, 0, 130)
        downBtn.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
        downBtn.BackgroundTransparency = 0.3
        downBtn.Text = "‚¨áÔ∏è DOWN (70)"
        downBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        downBtn.TextSize = 18
        downBtn.Font = Enum.Font.SourceSansBold
        downBtn.Parent = frame
        
        local downCorner = Instance.new("UICorner")
        downCorner.CornerRadius = UDim.new(0, 12)
        downCorner.Parent = downBtn
        
        local downStroke = Instance.new("UIStroke")
        downStroke.Color = Color3.fromRGB(200, 0, 100)
        downStroke.Transparency = 0.5
        downStroke.Thickness = 2
        downStroke.Parent = downBtn
        
        -- Button hover effects
        local upHover = TweenService:Create(upBtn, TweenInfo.new(0.2), {BackgroundTransparency = 0.1})
        local upNormal = TweenService:Create(upBtn, TweenInfo.new(0.2), {BackgroundTransparency = 0.3})
        local downHover = TweenService:Create(downBtn, TweenInfo.new(0.2), {BackgroundTransparency = 0.1})
        local downNormal = TweenService:Create(downBtn, TweenInfo.new(0.2), {BackgroundTransparency = 0.3})
        
        upBtn.MouseEnter:Connect(function() upHover:Play() end)
        upBtn.MouseLeave:Connect(function() upNormal:Play() end)
        downBtn.MouseEnter:Connect(function() downHover:Play() end)
        downBtn.MouseLeave:Connect(function() downNormal:Play() end)
        
        -- Button functions
        upBtn.MouseButton1Click:Connect(function()
            if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                player.Character.HumanoidRootPart.CFrame = player.Character.HumanoidRootPart.CFrame + Vector3.new(0, 165, 0)
            end
        end)
        
        downBtn.MouseButton1Click:Connect(function()
            if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                player.Character.HumanoidRootPart.CFrame = player.Character.HumanoidRootPart.CFrame - Vector3.new(0, 70, 0)
            end
        end)
        
        -- Make entire GUI draggable
        local dragStart = nil
        local startPos = nil
        local isDragging = false
        
        titleBar.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                isDragging = true
                dragStart = input.Position
                startPos = frame.Position
            end
        end)
        
        titleBar.InputChanged:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseMovement and isDragging then
                local delta = input.Position - dragStart
                frame.Position = UDim2.new(
                    startPos.X.Scale,
                    startPos.X.Offset + delta.X,
                    startPos.Y.Scale,
                    startPos.Y.Offset + delta.Y
                )
            end
        end)
        
        titleBar.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                isDragging = false
            end
        end)
    end
})

-- Infinite Jump
Tabs.Misc:AddToggle("InfiniteJump", {
    Title = "Infinite Jump",
    Default = false,
    Callback = function(value)
        infiniteJumpEnabled = value
        
        if infiniteJumpConnection then
            infiniteJumpConnection:Disconnect()
            infiniteJumpConnection = nil
        end
        
        if value then
            infiniteJumpConnection = UserInputService.JumpRequest:Connect(function()
                if player.Character and player.Character:FindFirstChild("Humanoid") then
                    player.Character.Humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
                end
            end)
        end
    end
})

-- Update money label
local function updateMoneyLabel()
    local leaderstats = player:FindFirstChild("leaderstats")
    if leaderstats then
        local money = leaderstats:FindFirstChild("Money") or leaderstats:FindFirstChild("Cash") or leaderstats:FindFirstChild("Coins")
        if money then
            moneyLabel:SetDesc(tostring(money.Value))
        end
    end
end

-- Auto collect money function
local function autoCollectMoneyFunc()
    if not autoCollectMoney then return end
    
    for _, v in pairs(workspace:GetDescendants()) do
        if v.Name:lower():find("money") or v.Name:lower():find("cash") or v.Name:lower():find("coin") then
            if v:IsA("Part") and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                local distance = (v.Position - player.Character.HumanoidRootPart.Position).Magnitude
                if distance <= 50 then
                    firetouchinterest(player.Character.HumanoidRootPart, v, 0)
                    firetouchinterest(player.Character.HumanoidRootPart, v, 1)
                end
            end
        end
    end
end

-- Fast steal function
local function fastStealFunc()
    if not fastStealEnabled then return end
    
    for _, v in pairs(workspace:GetDescendants()) do
        if v:IsA("ProximityPrompt") then
            v.HoldDuration = 0
            v.Duration = 0
        end
    end
end

-- ESP functions
local function updateESP()
    if espPlayersEnabled then
        for _, targetPlayer in pairs(Players:GetPlayers()) do
            if targetPlayer ~= Players.LocalPlayer and targetPlayer.Character then
                local highlight = targetPlayer.Character:FindFirstChild("Highlight")
                if not highlight then
                    highlight = Instance.new("Highlight")
                    highlight.Parent = targetPlayer.Character
                    highlight.FillColor = Color3.fromRGB(255, 0, 0)
                    highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
                end
            end
        end
    end
    
    if espBoxEnabled then
        for _, targetPlayer in pairs(Players:GetPlayers()) do
            if targetPlayer ~= Players.LocalPlayer and targetPlayer.Character then
                if not targetPlayer.Character:FindFirstChild("ESPBox") then
                    createESPBox(targetPlayer.Character)
                end
            end
        end
    end
end

-- Handle new players joining
Players.PlayerAdded:Connect(function(newPlayer)
    newPlayer.CharacterAdded:Connect(function(character)
        wait(1) -- Wait for character to fully load
        if espPlayersEnabled and newPlayer ~= Players.LocalPlayer then
            local highlight = Instance.new("Highlight")
            highlight.Parent = character
            highlight.FillColor = Color3.fromRGB(255, 0, 0)
            highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
        end
        if espBoxEnabled and newPlayer ~= Players.LocalPlayer then
            createESPBox(character)
        end
    end)
end)

-- Handle player leaving
Players.PlayerRemoving:Connect(function(leavingPlayer)
    if leavingPlayer.Character then
        local highlight = leavingPlayer.Character:FindFirstChild("Highlight")
        if highlight then
            highlight:Destroy()
        end
        removeESPBox(leavingPlayer.Character)
    end
end)

-- Main loop
RunService.Heartbeat:Connect(function()
    updateMoneyLabel()
    autoCollectMoneyFunc()
    fastStealFunc()
    updateESP()
end)

-- Configure managers
SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
InterfaceManager:SetFolder("FluentMobile")
SaveManager:SetFolder("FluentMobile/config")

-- Select first tab
Window:SelectTab(1)

-- Loading notification
Fluent:Notify({
    Title = "Loaded",
    Content = "Mobile script loaded successfully!",
    Duration = 5,
    Image = "rbxassetid://7072717836"
})

-- Load auto config
SaveManager:LoadAutoloadConfig()

-- Keep persistent image when menu is closed
