-- Water Hub Script - Optimized Edition v5.1
-- Performance optimized to prevent freezing and lag

-- Services (cached once)
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local CoreGui = game:GetService("CoreGui")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local StarterGui = game:GetService("StarterGui")
local VirtualUser = game:GetService("VirtualUser")
local Workspace = game:GetService("Workspace")

-- Performance optimizations
local player = Players.LocalPlayer
local camera = Workspace.CurrentCamera
local isMobile = UserInputService.TouchEnabled and not UserInputService.KeyboardEnabled

-- Global variables
local waterHubGui = nil
local minimizedIcon = nil
local connections = {}
local states = {
    infiniteJump = false,
    speedBoost = false,
    espPlayers = false,
    noclip = false,
    fly = false,
    godMode = true,
    float = false
}

local basePosition = nil
local originalWalkSpeed = 16
local espObjects = {}

-- Optimized Color Scheme (fewer objects)
local colors = {
    primary = Color3.fromRGB(0, 170, 255),
    secondary = Color3.fromRGB(0, 140, 210),
    background = Color3.fromRGB(25, 30, 40),
    surface = Color3.fromRGB(35, 40, 50),
    surfaceLight = Color3.fromRGB(45, 50, 60),
    success = Color3.fromRGB(40, 167, 69),
    danger = Color3.fromRGB(220, 53, 69),
    warning = Color3.fromRGB(255, 193, 7),
    text = Color3.fromRGB(255, 255, 255),
    textSecondary = Color3.fromRGB(200, 200, 200)
}

-- Simplified bypass setup (performance optimized)
local function setupBypass()
    pcall(function()
        -- Simple anti-idle only
        player.Idled:Connect(function()
            VirtualUser:Button2Down(Vector2.new(0, 0), camera.CFrame)
            wait(1)
            VirtualUser:Button2Up(Vector2.new(0, 0), camera.CFrame)
        end)
    end)
end

-- Optimized utility functions
local function getCharacter()
    return player.Character
end

local function getHumanoid()
    local char = getCharacter()
    return char and char:FindFirstChildOfClass("Humanoid")
end

local function getRootPart()
    local char = getCharacter()
    return char and char:FindFirstChild("HumanoidRootPart")
end

-- Simplified UI creation (no heavy animations)
local function createFrame(parent, size, position, color, transparency)
    local frame = Instance.new("Frame")
    frame.Size = size
    frame.Position = position
    frame.BackgroundColor3 = color
    frame.BackgroundTransparency = transparency or 0
    frame.BorderSizePixel = 0
    frame.Parent = parent
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = frame
    
    return frame
end

local function createButton(parent, size, position, color, text)
    local button = Instance.new("TextButton")
    button.Size = size
    button.Position = position
    button.BackgroundColor3 = color
    button.Text = text
    button.TextColor3 = colors.text
    button.TextScaled = true
    button.Font = Enum.Font.SourceSans
    button.BorderSizePixel = 0
    button.Parent = parent
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = button
    
    return button
end

-- Simplified switch (no heavy animations)
local function createSwitch(parent, position, callback, initialState)
    local switchFrame = createFrame(parent, 
        UDim2.new(0, 40, 0, 20), 
        position, 
        initialState and colors.primary or Color3.fromRGB(80, 80, 80), 
        0
    )
    
    local switchButton = createFrame(switchFrame, 
        UDim2.new(0, 16, 0, 16), 
        initialState and UDim2.new(1, -18, 0, 2) or UDim2.new(0, 2, 0, 2), 
        Color3.fromRGB(255, 255, 255), 
        0
    )
    
    local isOn = initialState or false
    
    switchFrame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            isOn = not isOn
            
            -- Simple position change (no animation)
            switchButton.Position = isOn and UDim2.new(1, -18, 0, 2) or UDim2.new(0, 2, 0, 2)
            switchFrame.BackgroundColor3 = isOn and colors.primary or Color3.fromRGB(80, 80, 80)
            
            if callback then
                callback(isOn)
            end
        end
    end)
    
    return switchFrame
end

-- Simple drag function (performance optimized)
local function makeDraggable(frame)
    local dragging = false
    local dragStart = nil
    local startPos = nil
    
    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
        end
    end)
    
    frame.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = false
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            frame.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end)
end

-- Optimized feature functions
local function toggleGodMode(enabled)
    states.godMode = enabled
    
    if connections.godMode then
        connections.godMode:Disconnect()
    end
    
    if enabled then
        connections.godMode = RunService.Heartbeat:Connect(function()
            local humanoid = getHumanoid()
            if humanoid then
                humanoid.Health = humanoid.MaxHealth
            end
        end)
    end
end

local function toggleInfiniteJump(enabled)
    states.infiniteJump = enabled
    
    if connections.infiniteJump then
        connections.infiniteJump:Disconnect()
    end
    
    if enabled then
        connections.infiniteJump = UserInputService.JumpRequest:Connect(function()
            local humanoid = getHumanoid()
            if humanoid then
                humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
            end
        end)
    end
end

local function toggleSpeedBoost(enabled)
    states.speedBoost = enabled
    
    if connections.speedBoost then
        connections.speedBoost:Disconnect()
    end
    
    if enabled then
        connections.speedBoost = RunService.Heartbeat:Connect(function()
            local humanoid = getHumanoid()
            if humanoid then
                humanoid.WalkSpeed = 25
            end
        end)
    else
        local humanoid = getHumanoid()
        if humanoid then
            humanoid.WalkSpeed = originalWalkSpeed
        end
    end
end

local function toggleNoclip(enabled)
    states.noclip = enabled
    
    if connections.noclip then
        connections.noclip:Disconnect()
    end
    
    if enabled then
        connections.noclip = RunService.Stepped:Connect(function()
            local character = getCharacter()
            if character then
                for _, part in pairs(character:GetChildren()) do
                    if part:IsA("BasePart") then
                        part.CanCollide = false
                    end
                end
            end
        end)
    end
end

local function toggleFly(enabled)
    states.fly = enabled
    
    if connections.fly then
        connections.fly:Disconnect()
    end
    
    if enabled then
        local bodyVelocity = Instance.new("BodyVelocity")
        bodyVelocity.MaxForce = Vector3.new(4000, 4000, 4000)
        bodyVelocity.Velocity = Vector3.new(0, 0, 0)
        
        local rootPart = getRootPart()
        if rootPart then
            bodyVelocity.Parent = rootPart
        end
        
        connections.fly = RunService.Heartbeat:Connect(function()
            local moveVector = Vector3.new(0, 0, 0)
            
            if UserInputService:IsKeyDown(Enum.KeyCode.W) then
                moveVector = moveVector + camera.CFrame.LookVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.S) then
                moveVector = moveVector - camera.CFrame.LookVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.A) then
                moveVector = moveVector - camera.CFrame.RightVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.D) then
                moveVector = moveVector + camera.CFrame.RightVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.Space) then
                moveVector = moveVector + Vector3.new(0, 1, 0)
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then
                moveVector = moveVector - Vector3.new(0, 1, 0)
            end
            
            if bodyVelocity then
                bodyVelocity.Velocity = moveVector * 50
            end
        end)
    else
        local rootPart = getRootPart()
        if rootPart then
            local bodyVelocity = rootPart:FindFirstChild("BodyVelocity")
            if bodyVelocity then
                bodyVelocity:Destroy()
            end
        end
    end
end

-- Mobile float function
local function toggleFloat(enabled)
    states.float = enabled
    
    if connections.float then
        connections.float:Disconnect()
    end
    
    if enabled then
        local rootPart = getRootPart()
        if rootPart then
            local bodyPosition = Instance.new("BodyPosition")
            bodyPosition.MaxForce = Vector3.new(0, math.huge, 0)
            bodyPosition.Position = rootPart.Position
            bodyPosition.Parent = rootPart
            
            connections.float = RunService.Heartbeat:Connect(function()
                if bodyPosition then
                    bodyPosition.Position = rootPart.Position
                end
            end)
        end
    else
        local rootPart = getRootPart()
        if rootPart then
            local bodyPosition = rootPart:FindFirstChild("BodyPosition")
            if bodyPosition then
                bodyPosition:Destroy()
            end
        end
    end
end

-- Simplified ESP (performance optimized)
local function toggleESP(enabled)
    states.espPlayers = enabled
    
    -- Clear existing ESP
    for _, objects in pairs(espObjects) do
        for _, obj in pairs(objects) do
            if obj then obj:Destroy() end
        end
    end
    espObjects = {}
    
    if connections.esp then
        connections.esp:Disconnect()
    end
    
    if enabled then
        connections.esp = RunService.Heartbeat:Connect(function()
            for _, targetPlayer in pairs(Players:GetPlayers()) do
                if targetPlayer ~= player and targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart") then
                    if not espObjects[targetPlayer] then
                        espObjects[targetPlayer] = {}
                        
                        -- Simple box only
                        local box = Instance.new("BoxHandleAdornment")
                        box.Size = targetPlayer.Character:GetExtentsSize()
                        box.Color3 = Color3.fromRGB(255, 100, 100)
                        box.Transparency = 0.5
                        box.AlwaysOnTop = true
                        box.Adornee = targetPlayer.Character.HumanoidRootPart
                        box.Parent = targetPlayer.Character.HumanoidRootPart
                        
                        table.insert(espObjects[targetPlayer], box)
                    end
                end
            end
        end)
    end
end

-- Minimized icon (simplified)
local function createMinimizedIcon()
    if minimizedIcon then
        minimizedIcon:Destroy()
    end
    
    minimizedIcon = Instance.new("ScreenGui")
    minimizedIcon.Name = "WaterHubMinimized"
    minimizedIcon.Parent = CoreGui
    minimizedIcon.ResetOnSpawn = false
    
    local iconButton = createButton(minimizedIcon, 
        UDim2.new(0, 60, 0, 60), 
        UDim2.new(0, 20, 0, 20), 
        colors.primary, 
        "💧"
    )
    iconButton.TextSize = 24
    
    makeDraggable(iconButton)
    
    iconButton.MouseButton1Click:Connect(function()
        minimizedIcon:Destroy()
        minimizedIcon = nil
        createMainGui()
    end)
end

-- Main GUI (simplified and optimized)
local function createMainGui()
    if waterHubGui then
        waterHubGui:Destroy()
    end
    
    waterHubGui = Instance.new("ScreenGui")
    waterHubGui.Name = "WaterHubMain"
    waterHubGui.Parent = CoreGui
    waterHubGui.ResetOnSpawn = false
    
    -- Smaller main frame for better performance
    local mainFrame = createFrame(waterHubGui, 
        UDim2.new(0, 300, 0, 400), 
        UDim2.new(0.5, -150, 0.5, -200), 
        colors.background, 
        0.1
    )
    
    -- Header
    local header = createFrame(mainFrame, 
        UDim2.new(1, 0, 0, 30), 
        UDim2.new(0, 0, 0, 0), 
        colors.primary, 
        0
    )
    makeDraggable(mainFrame)
    
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(0.7, 0, 1, 0)
    title.Position = UDim2.new(0, 10, 0, 0)
    title.BackgroundTransparency = 1
    title.Text = "💧 Water Hub"
    title.TextColor3 = colors.text
    title.TextScaled = true
    title.Font = Enum.Font.SourceSansBold
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.Parent = header
    
    -- Window controls
    local minimizeBtn = createButton(header, 
        UDim2.new(0, 25, 0, 25), 
        UDim2.new(1, -55, 0.5, -12.5), 
        colors.warning, 
        "−"
    )
    
    local closeBtn = createButton(header, 
        UDim2.new(0, 25, 0, 25), 
        UDim2.new(1, -27, 0.5, -12.5), 
        colors.danger, 
        "×"
    )
    
    -- Content area with scroll
    local scrollFrame = Instance.new("ScrollingFrame")
    scrollFrame.Size = UDim2.new(1, -10, 1, -40)
    scrollFrame.Position = UDim2.new(0, 5, 0, 35)
    scrollFrame.BackgroundColor3 = colors.surface
    scrollFrame.BackgroundTransparency = 0.1
    scrollFrame.BorderSizePixel = 0
    scrollFrame.ScrollBarThickness = 6
    scrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
    scrollFrame.Parent = mainFrame
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = scrollFrame
    
    -- Feature list (simplified)
    local yPos = 10
    
    local function addFeature(text, callback, initialState)
        local container = Instance.new("Frame")
        container.Size = UDim2.new(1, -20, 0, 30)
        container.Position = UDim2.new(0, 10, 0, yPos)
        container.BackgroundTransparency = 1
        container.Parent = scrollFrame
        
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1, -50, 1, 0)
        label.BackgroundTransparency = 1
        label.Text = text
        label.TextColor3 = colors.text
        label.TextScaled = true
        label.Font = Enum.Font.SourceSans
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.Parent = container
        
        createSwitch(container, UDim2.new(1, -45, 0.5, -10), callback, initialState)
        
        yPos = yPos + 35
    end
    
    -- Add features
    addFeature("🛡️ God Mode", toggleGodMode, states.godMode)
    addFeature("🦘 Infinite Jump", toggleInfiniteJump, states.infiniteJump)
    
    if isMobile then
        addFeature("🎈 Float", toggleFloat, states.float)
    end
    
    addFeature("⚡ Speed Boost", toggleSpeedBoost, states.speedBoost)
    addFeature("👻 Noclip", toggleNoclip, states.noclip)
    addFeature("✈️ Fly", toggleFly, states.fly)
    addFeature("👁️ ESP", toggleESP, states.espPlayers)
    
    -- Base system
    local baseSection = createFrame(scrollFrame, 
        UDim2.new(1, -20, 0, 80), 
        UDim2.new(0, 10, 0, yPos), 
        colors.surfaceLight, 
        0.1
    )
    yPos = yPos + 85
    
    local baseTitle = Instance.new("TextLabel")
    baseTitle.Size = UDim2.new(1, -10, 0, 20)
    baseTitle.Position = UDim2.new(0, 5, 0, 5)
    baseTitle.BackgroundTransparency = 1
    baseTitle.Text = "📍 Base System"
    baseTitle.TextColor3 = colors.primary
    baseTitle.TextScaled = true
    baseTitle.Font = Enum.Font.SourceSansBold
    baseTitle.TextXAlignment = Enum.TextXAlignment.Left
    baseTitle.Parent = baseSection
    
    local setBaseBtn = createButton(baseSection, 
        UDim2.new(0.48, 0, 0, 25), 
        UDim2.new(0.02, 0, 0, 30), 
        colors.success, 
        "Set"
    )
    
    local tpBaseBtn = createButton(baseSection, 
        UDim2.new(0.48, 0, 0, 25), 
        UDim2.new(0.52, 0, 0, 30), 
        colors.warning, 
        "TP"
    )
    
    local baseStatus = Instance.new("TextLabel")
    baseStatus.Size = UDim2.new(1, -10, 0, 15)
    baseStatus.Position = UDim2.new(0, 5, 0, 60)
    baseStatus.BackgroundTransparency = 1
    baseStatus.Text = basePosition and "Base set" or "No base set"
    baseStatus.TextColor3 = colors.textSecondary
    baseStatus.TextScaled = true
    baseStatus.Font = Enum.Font.SourceSans
    baseStatus.TextXAlignment = Enum.TextXAlignment.Left
    baseStatus.Parent = baseSection
    
    -- Steal helper
    local stealBtn = createButton(scrollFrame, 
        UDim2.new(1, -20, 0, 35), 
        UDim2.new(0, 10, 0, yPos), 
        colors.primary, 
        "💰 Steal Helper"
    )
    yPos = yPos + 40
    
    -- Update canvas size
    scrollFrame.CanvasSize = UDim2.new(0, 0, 0, yPos + 10)
    
    -- Event handlers
    minimizeBtn.MouseButton1Click:Connect(function()
        waterHubGui:Destroy()
        createMinimizedIcon()
    end)
    
    closeBtn.MouseButton1Click:Connect(function()
        waterHubGui:Destroy()
        waterHubGui = nil
    end)
    
    setBaseBtn.MouseButton1Click:Connect(function()
        local rootPart = getRootPart()
        if rootPart then
            basePosition = rootPart.Position
            baseStatus.Text = "Base set"
        end
    end)
    
    tpBaseBtn.MouseButton1Click:Connect(function()
        if basePosition then
            local rootPart = getRootPart()
            if rootPart then
                rootPart.CFrame = CFrame.new(basePosition)
            end
        end
    end)
    
    local stealActive = false
    stealBtn.MouseButton1Click:Connect(function()
        local rootPart = getRootPart()
        if rootPart then
            if stealActive then
                rootPart.CFrame = rootPart.CFrame - Vector3.new(0, 50, 0)
                stealBtn.Text = "💰 Steal Helper"
                stealActive = false
            else
                rootPart.CFrame = CFrame.new(rootPart.Position.X, 165, rootPart.Position.Z)
                stealBtn.Text = "⬇️ Down"
                stealActive = true
            end
        end
    end)
end

-- Simple initialization (no loading screen to prevent lag)
local function initialize()
    setupBypass()
    
    -- Small delay to prevent freeze
    wait(0.1)
    
    createMainGui()
    
    -- Enable god mode by default
    toggleGodMode(true)
    
    StarterGui:SetCore("SendNotification", {
        Title = "Water Hub",
        Text = "Loaded successfully!",
        Duration = 3
    })
end

-- Character respawn handler
player.CharacterAdded:Connect(function()
    wait(1)
    
    -- Restore active states
    if states.godMode then toggleGodMode(true) end
    if states.speedBoost then toggleSpeedBoost(true) end
    if states.infiniteJump then toggleInfiniteJump(true) end
    if states.float then toggleFloat(true) end
    if states.noclip then toggleNoclip(true) end
    if states.fly then toggleFly(true) end
    if states.espPlayers then toggleESP(true) end
end)

-- Start the script
initialize()
