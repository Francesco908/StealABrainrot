-- Carica la libreria Fluent
local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

-- Crea la finestra principale
local Window = Fluent:CreateWindow({
    Title = "Script Semplice",
    SubTitle = "Test UI",
    TabWidth = 160,
    Size = UDim2.fromOffset(460, 460),
    Acrylic = true,
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.LeftControl -- Tasto per minimizzare/ripristinare
})

-- Crea l'immagine persistente (sempre visibile)
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

local persistentGui = Instance.new("ScreenGui")
persistentGui.Name = "FluentPersistentButton"
persistentGui.Parent = playerGui
persistentGui.ResetOnSpawn = false
persistentGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
persistentGui.Enabled = true

-- Immagine "fighissima" (personalizza con il tuo asset ID)
local imageButton = Instance.new("ImageButton")
imageButton.Name = "PersistentControl"
imageButton.Size = UDim2.fromOffset(70, 70)
imageButton.Position = UDim2.new(0, 20, 0.5, -35) -- Centro sinistra
imageButton.AnchorPoint = Vector2.new(0, 0.5)
imageButton.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
imageButton.BorderSizePixel = 0
imageButton.Image = "rbxassetid://7072717836" -- Icona razzo (sostituisci con il tuo ID)
imageButton.ScaleType = Enum.ScaleType.Fit
imageButton.Parent = persistentGui

-- Effetto trasparenza
imageButton.BackgroundTransparency = 0.5
imageButton.ImageTransparency = 0.2

-- Arrotonda gli angoli
local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0.3, 0)
corner.Parent = imageButton

-- Effetto hover
local TweenService = game:GetService("TweenService")
local hoverTween = TweenService:Create(imageButton, TweenInfo.new(0.3), {
    BackgroundTransparency = 0.2,
    ImageTransparency = 0,
    Size = UDim2.fromOffset(75, 75)
})
local normalTween = TweenService:Create(imageButton, TweenInfo.new(0.3), {
    BackgroundTransparency = 0.5,
    ImageTransparency = 0.2,
    Size = UDim2.fromOffset(70, 70)
})

imageButton.MouseEnter:Connect(function()
    hoverTween:Play()
end)
imageButton.MouseLeave:Connect(function()
    normalTween:Play()
end)

-- Variabili per rendere l'immagine trascinabile
local dragging = false
local dragStart = nil
local startPos = nil

-- Funzioni per il trascinamento
local function onDragStart(input)
    dragging = true
    dragStart = input.Position
    startPos = imageButton.Position
end

local function onDragEnd(input)
    dragging = false
end

local function onDragMove(input)
    if dragging then
        local delta = input.Position - dragStart
        imageButton.Position = UDim2.new(
            startPos.X.Scale,
            startPos.X.Offset + delta.X,
            startPos.Y.Scale,
            startPos.Y.Offset + delta.Y
        )
    end
end

-- Connetti gli eventi di trascinamento
imageButton.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        onDragStart(input)
    end
end)

imageButton.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        onDragEnd(input)
    end
end)

imageButton.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        onDragMove(input)
    end
end)

-- Funzione per alternare la visibilità del menu
local function toggleMenu()
    if Window and Window.Root then
        Window.Root.Visible = not Window.Root.Visible
    end
end

-- Distingui tra click e trascinamento
local clickStartTime = 0
local function isClick(input)
    local currentTime = tick()
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        if currentTime - clickStartTime < 0.3 and not dragging then
            return true
        end
    end
    return false
end

-- Click handler semplificato
imageButton.MouseButton1Click:Connect(function()
    if not dragging then
        toggleMenu()
    end
end)

-- Blocca l'evento LeftControl dal gioco quando la GUI è attiva
local UserInputService = game:GetService("UserInputService")
local originalLeftControlConnection

-- Intercetta LeftControl solo quando necessario
local function onKeyDown(key, gameProcessed)
    if key.KeyCode == Enum.KeyCode.LeftControl then
        -- Previene che il gioco riceva l'input se la GUI è attiva
        if persistentGui.Enabled then
            toggleMenu()
            return -- Blocca l'evento
        end
    end
end

-- Connetti l'evento
UserInputService.InputBegan:Connect(onKeyDown)

-- Crea le tab
local Tabs = {
    Main = Window:AddTab({ Title = "Main", Icon = "home" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}

-- TAB MAIN
Tabs.Main:AddButton({
    Title = "Pulsante Test",
    Description = "Clicca per testare",
    Callback = function()
        Fluent:Notify({
            Title = "Test",
            Content = "Pulsante premuto!",
            Duration = 3
        })
    end
})

-- TAB SETTINGS
Tabs.Settings:AddButton({
    Title = "Pulsante Settings",
    Description = "Pulsante nelle impostazioni",
    Callback = function()
        Fluent:Notify({
            Title = "Settings",
            Content = "Pulsante settings premuto!",
            Duration = 3
        })
    end
})

-- Configura i manager
SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
InterfaceManager:SetFolder("FluentTest")
SaveManager:SetFolder("FluentTest/config")
InterfaceManager:BuildInterfaceSection(Tabs.Settings)
SaveManager:BuildConfigSection(Tabs.Settings)

-- Seleziona la prima tab
Window:SelectTab(1)

-- Notifica di caricamento
Fluent:Notify({
    Title = "Caricato",
    Content = "Script caricato con successo!",
    Duration = 5,
    Image = "rbxassetid://7072717836" -- Stessa icona dell'immagine persistente
})

-- Carica configurazione automatica
SaveManager:LoadAutoloadConfig()

-- Mantieni l'immagine anche quando il menu viene chiuso
-- (Rimuovi la connessione Unloaded per mantenere persistentGui)
